```Proyecto SaaS Centinela Cloud/ops/docker-compose.yml#L1-200
name: centinela

services:
  postgres:
    image: postgres:16-alpine
    container_name: centinela-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-centinela}
      POSTGRES_USER: ${POSTGRES_USER:-centinela}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-centinela_dev_password}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-centinela} -d ${POSTGRES_DB:-centinela}"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7-alpine
    container_name: centinela-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 5s
      timeout: 3s
      retries: 20

  backend:
    # Placeholder: you will build this from ./backend once Dockerfile exists
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: centinela-backend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${BACKEND_PORT_INTERNAL:-3000}

      # DB
      DATABASE_URL: ${DATABASE_URL:-postgres://centinela:centinela_dev_password@postgres:5432/centinela}

      # Redis (optional but wired)
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}

      # Ingest auth (collector -> backend)
      INGEST_SHARED_SECRET: ${INGEST_SHARED_SECRET:-change_me_dev_secret}

      # Retention
      RETENTION_DAYS: ${RETENTION_DAYS:-7}

      # Email (SMTP)
      EMAIL_FROM: ${EMAIL_FROM:-"Centinela <alerts@example.com>"}
      SMTP_HOST: ${SMTP_HOST:-smtp}
      SMTP_PORT: ${SMTP_PORT:-25}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_SECURE: ${SMTP_SECURE:-false}

      # Locale
      DEFAULT_LOCALE: ${DEFAULT_LOCALE:-es}

      # Public URL (used for links in emails)
      APP_BASE_URL: ${APP_BASE_URL:-http://localhost:3000}
    ports:
      - "${BACKEND_PORT:-3000}:${BACKEND_PORT_INTERNAL:-3000}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${BACKEND_PORT_INTERNAL:-3000}/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 20

  collector:
    # Placeholder: you will build this from ./collector once Dockerfile exists
    build:
      context: ../collector
      dockerfile: Dockerfile
    container_name: centinela-collector
    restart: unless-stopped
    environment:
      # Where to POST syslog lines
      BACKEND_INGEST_URL: ${BACKEND_INGEST_URL:-http://backend:${BACKEND_PORT_INTERNAL:-3000}/v1/ingest/syslog}

      # Auth
      INGEST_TOKEN: ${INGEST_TOKEN:-change_me_dev_secret}

      # Tenancy metadata (for the MVP you can hardcode one tenant/site)
      TENANT_ID: ${TENANT_ID:-dev-tenant}
      SITE_ID: ${SITE_ID:-dev-site}
      SOURCE_ID: ${SOURCE_ID:-dev-fortigate}

      # Syslog listeners
      LISTEN_UDP: ${LISTEN_UDP:-:5514}
      LISTEN_TCP: ${LISTEN_TCP:-:5514}

      # Optional: tag incoming messages (helpful for debugging)
      COLLECTOR_NAME: ${COLLECTOR_NAME:-collector-local}
    ports:
      # Non-privileged default port for local dev (5514). Map to 514 in production if desired.
      - "${SYSLOG_PORT_UDP:-5514}:5514/udp"
      - "${SYSLOG_PORT_TCP:-5514}:5514/tcp"
    depends_on:
      backend:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
